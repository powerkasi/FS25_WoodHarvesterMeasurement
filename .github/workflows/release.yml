name: Auto Release

on:
  push:
    branches:
      - master

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for version change
        id: check_version
        run: |
          NEW_VER=$(grep -oP 'Current version \K[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' README.md)
          OLD_VER=$(git show HEAD~1:README.md | grep -oP 'Current version \K[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' || echo "0.0.0.0")
          
          echo "New: $NEW_VER"
          echo "Old: $OLD_VER"
          
          if [ "$NEW_VER" != "$OLD_VER" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "version=$NEW_VER" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Zip Archive
        if: steps.check_version.outputs.changed == 'true'
        run: |
          zip -r FS25_WoodHarvesterMeasurement.zip WoodHarvesterMeasurement.lua modDesc.xml Register.lua icon_WHM.dds libs/ classes/ events/ gui/ hud/
          
      - name: Create GitHub Release
        if: steps.check_version.outputs.changed == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.check_version.outputs.version }}
          name: Release ${{ steps.check_version.outputs.version }}
          files: FS25_WoodHarvesterMeasurement.zip
          generate_release_notes: true
